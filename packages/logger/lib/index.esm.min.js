var EventType,Config;function listener(n){window.addEventListener(EventType.EVENT.toString(),function(e){n&&n(e)},!1)}function typeIs(e){return{"[object String]":"string","[object Number]":"number","[object Boolean]":"boolean","[object Symbol]":"symbol","[object Undefined]":"undefined","[object Null]":"null","[object Function]":"function","[object Date]":"date","[object Array]":"array","[object Object]":"object","[object Map]":"map","[object RegExp]":"regexp","[object Error]":"error","[object HTMLDocument]":"document","[object global]":"window"}[Object.prototype.toString.call(e)]}function formatDate(e,n){var t,o=n,r={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(t in/(y+)/.test(n)&&(o=o.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),r)new RegExp("("+t+")").test(o)&&(o=o.replace(RegExp.$1,1==RegExp.$1.length?r[t]:("00"+r[t]).substr((""+r[t]).length)));return o}(EventType=EventType||{}).EVENT="___beeweb_logger_event___",function(e){e.TRACE_ID="___beeweb_trace_id___",e.LOCATION_URL="___beeweb_logger_location_url___",e.SERVER_URL="___beeweb_logger_server_url__",e.ENCRYPTION="___beeweb_logger_encryption__",e.STATEMENT="___beeweb_statement__"}(Config=Config||{});var cacheLocation,Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var n,t,o,r,a,i,c="",d=0;for(e=Base64._utf8_encode(e);d<e.length;)o=(i=e.charCodeAt(d++))>>2,r=(3&i)<<4|(n=e.charCodeAt(d++))>>4,a=(15&n)<<2|(t=e.charCodeAt(d++))>>6,i=63&t,isNaN(n)?a=i=64:isNaN(t)&&(i=64),c=c+this._keyStr.charAt(o)+this._keyStr.charAt(r)+this._keyStr.charAt(a)+this._keyStr.charAt(i);return c},_utf8_encode:function(e){e=e.replace(/rn/g,"n");for(var n="",t=0;t<e.length;t++){var o=e.charCodeAt(t);o<128?n+=String.fromCharCode(o):(127<o&&o<2048?n+=String.fromCharCode(o>>6|192):(n+=String.fromCharCode(o>>12|224),n+=String.fromCharCode(o>>6&63|128)),n+=String.fromCharCode(63&o|128))}return n}};function getStatement(){return window[Config.STATEMENT.toString()]||{}}function getTraceId(){return window[Config.TRACE_ID.toString()]}function appendJs(e,n){var t=document.createElement("script");return t.src=e,t.onload=n,document.head.appendChild(t),function(){document.head.removeChild(t)}}function getAddressInfoByBaiduMap(){return new Promise(function(o){var r,e=window[Config.LOCATION_URL.toString()];e?cacheLocation?o(cacheLocation):r=appendJs("https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js",function(){window.$.ajax({url:e,type:"POST",dataType:"jsonp",success:function(e){var n=e.content.point,t=n.x,n=n.y,t=(new window.BMap.MercatorProjection).pointToLngLat(new window.BMap.Pixel(t,n)),n=t.lng,t=t.lat;r(),o(cacheLocation={lng:n,lat:t,location:e})}})}):o({err:"未配置"})})}function getAddressInfo(){return new Promise(function(i){cacheLocation?i(cacheLocation):fetch("https://ipapi.co/json/").then(function(e){return e.json()}).then(function(e){var n=e.ip,t=e.latitude,o=e.longitude,r=e.version,a=e.region,e=e.city;i(cacheLocation={ip:n,latitude:t,longitude:o,version:r,region:a,city:e})}).catch(function(e){i({err:"位置获取异常"})})})}function getKernelVersion(e){var n,t={msie:!1,firefox:!1,opera:!1,safari:!1,chrome:!1,netscape:!1,appname:"unknown",version:0},o=window.navigator.userAgent.toLowerCase();switch(/(msie|firefox|opera|chrome|netscape)\D+(\d[\d.]*)/.test(o)?(t[RegExp.$1]=!0,t.appname=RegExp.$1,t.version=RegExp.$2):/version\D+(\d[\d.]*).*safari/.test(o)&&(t.safari=!0,t.appname="safari",t.version=RegExp.$2),e){case"name":n=t.appname;break;case"version":n=t.version;break;default:n=t.appname+" "+t.version}return n}function getOs(){var e="Unknown",n=navigator.userAgent.toLowerCase();return"Win32"!=navigator.platform&&"Windows"!=navigator.platform||(e="Windows"),"Mac68K"!=navigator.platform&&"MacPPC"!=navigator.platform&&"Macintosh"!=navigator.platform&&"MacIntel"!=navigator.platform||(e="Mac"),-1<n.indexOf("iPhone")&&(e="iphone"),-1<n.indexOf("iPod")&&(e="ipod"),-1<n.indexOf("iPad")&&(e="ipad"),e=-1<n.indexOf("Linux")?-1<n.indexOf("Android")?"Android":"Linux":e}function cleanArray(e){for(var n=[],t=0;t<e.length;t++)e[t]&&n.push(e[t]);return n}function queryToString(n){if(!n)return"";if("object"!==typeIs(n))return"";var e=cleanArray(Object.keys(n).map(function(e){return n[e]?"".concat(e,"=").concat(n[e]):""})).join("&");return e?"?".concat(e):""}function sender(e){var n=window[Config.SERVER_URL.toString()];n&&fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e}),mode:"cors"})}function asyncSenderTxt(e){var n=queryToString({data:e}),e=window[Config.SERVER_URL.toString()];e&&navigator.sendBeacon("".concat(e,"/async"),n)}function configMapURI(e){window[Config.LOCATION_URL.toString()]=e}function configServerURL(e){window[Config.SERVER_URL.toString()]=e}function configEncryption(e){window[Config.ENCRYPTION.toString()]=e}function configStatement(e){window[Config.STATEMENT.toString()]=e}function configTraceId(e){window[Config.TRACE_ID.toString()]=e}function loadConfig(e){var n=e.traceId,t=e.mapURI,o=e.serverURL,r=e.encryptionFunc,e=e.statement;n&&configTraceId(n),t&&configMapURI(t),o&&(configServerURL(o),listener(function(e){return sender(e.detail)})),e&&configStatement(e),r&&configEncryption(r)}function trigger(e){var n=window[Config.ENCRYPTION.toString()],n=n?"useDefault"===n?Base64.encode(JSON.stringify(e)):n(e):e;"unload"===e.stateType&&asyncSenderTxt(n);n=new CustomEvent(EventType.EVENT,{detail:n,bubbles:!1,cancelable:!0});window.dispatchEvent(n)}function handleCustom(e){trigger({eventType:"custom",traceId:getTraceId(),statement:getStatement(),content:e,url:window.location.href,kernel:getKernelVersion(),os:getOs(),createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss")})}function handleClick(e){trigger({eventType:"click",traceId:getTraceId(),statement:getStatement(),content:e,url:window.location.href,kernel:getKernelVersion(),os:getOs(),createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss")})}function pageTrigger(e,n,t,o,r){trigger({eventType:"page",traceId:getTraceId(),statement:getStatement(),stateType:e,url:t,pageStatus:o,stayTime:n,createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),kernel:getKernelVersion(),os:getOs(),address:r})}var cacheAddress={};function handlePage(n,t,o,r){window[Config.LOCATION_URL.toString()]?getAddressInfoByBaiduMap().then(function(e){pageTrigger(n,t,o,r,cacheAddress=e)}):getAddressInfo().then(function(e){pageTrigger(n,t,o,r,cacheAddress=e)})}function unloadPage(e,n,t,o){pageTrigger(e,n,t,o,cacheAddress)}function mountPageEvent(){function e(t){var o=window.history,r=o[t];return function(){var e=r.apply(o,arguments),n=new Event(t);return window.dispatchEvent(n),e}}var o=Date.now(),r="";function n(e){var n,n="load"===e?0:(n=Date.now(),t=n-o,o=n,t),t=window.location.href;"unload"!==e?(r&&handlePage(e,n,r,"leave"),handlePage(e,0,r=t,"enter")):unloadPage(e,n,t,"leave")}window.history.pushState=e("pushState"),window.history.replaceState=e("replaceState"),window.addEventListener("load",function(e){n("load")}),window.addEventListener("unload",function(e){n("unload")}),window.addEventListener("popstate",function(e){n("popstate")}),window.addEventListener("pushState",function(e){n("pushState")}),window.addEventListener("replaceState",function(e){n("replaceState")})}function mount(e){e&&loadConfig(e),mountPageEvent()}export{handleClick,handleCustom,listener,mount,mountPageEvent};
