var EventType,Config;function listener(t){window.addEventListener(EventType.EVENT.toString(),function(e){t&&t(e)},!1)}function sender(e){var t=window[Config.SERVER_URL.toString()];t&&fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:e}),mode:"cors"})}function configMapURI(e){window[Config.LOCATION_URL.toString()]=e}function configServerURL(e){window[Config.SERVER_URL.toString()]=e}function configEncryption(e){window[Config.ENCRYPTION.toString()]=e}function configStatement(e){window[Config.STATEMENT.toString()]=e}function configTraceId(e){window[Config.TRACE_ID.toString()]=e}function loadConfig(e){var t=e.traceId,n=e.mapURI,o=e.serverURL,a=e.encryptionFunc,e=e.statement;t&&configTraceId(t),n&&configMapURI(n),o&&(configServerURL(o),listener(function(e){return sender(e.detail)})),e&&configStatement(e),a&&configEncryption(a)}function formatDate(e,t){var n,o=t,a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};for(n in/(y+)/.test(t)&&(o=o.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+n+")").test(o)&&(o=o.replace(RegExp.$1,1==RegExp.$1.length?a[n]:("00"+a[n]).substr((""+a[n]).length)));return o}(EventType=EventType||{}).EVENT="___beeweb_logger_event___",function(e){e.TRACE_ID="___beeweb_trace_id___",e.LOCATION_URL="___beeweb_logger_location_url___",e.SERVER_URL="___beeweb_logger_server_url__",e.ENCRYPTION="___beeweb_logger_encryption__",e.STATEMENT="___beeweb_statement__"}(Config=Config||{});var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,n,o,a,r,i,c="",g=0;for(e=Base64._utf8_encode(e);g<e.length;)o=(i=e.charCodeAt(g++))>>2,a=(3&i)<<4|(t=e.charCodeAt(g++))>>4,r=(15&t)<<2|(n=e.charCodeAt(g++))>>6,i=63&n,isNaN(t)?r=i=64:isNaN(n)&&(i=64),c=c+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(r)+this._keyStr.charAt(i);return c},_utf8_encode:function(e){e=e.replace(/rn/g,"n");for(var t="",n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t+=String.fromCharCode(o):(127<o&&o<2048?t+=String.fromCharCode(o>>6|192):(t+=String.fromCharCode(o>>12|224),t+=String.fromCharCode(o>>6&63|128)),t+=String.fromCharCode(63&o|128))}return t}};function getNavigatorInfo(){var e=navigator;return{userAgent:e.userAgent,appCodeName:e.appCodeName,appName:e.appName,appVersion:e.appVersion,language:e.language,onLine:e.onLine,platform:e.platform,vendor:e.vendor}}function getStatement(){return window[Config.STATEMENT.toString()]||{}}function getTraceId(){return window[Config.TRACE_ID.toString()]}function appendJs(e,t){var n=document.createElement("script");return n.src=e,n.onload=t,document.head.appendChild(n),function(){document.head.removeChild(n)}}var cacheLocation=null;function getAddressInfo(){return new Promise(function(o){var a,e=window[Config.LOCATION_URL.toString()];e?cacheLocation?o(cacheLocation):a=appendJs("https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js",function(){window.$.ajax({url:e,type:"POST",dataType:"jsonp",success:function(e){var t=e.content.point,n=t.x,t=t.y,n=(new window.BMap.MercatorProjection).pointToLngLat(new window.BMap.Pixel(n,t)),t=n.lng,n=n.lat;a(),o(cacheLocation={lng:t,lat:n,location:e})}})}):o({err:"未配置"})})}function trigger(e){var t=window[Config.ENCRYPTION.toString()],e=t?"useDefault"===t?Base64.encode(JSON.stringify(e)):t(e):e,e=new CustomEvent(EventType.EVENT,{detail:e,bubbles:!1,cancelable:!0});window.dispatchEvent(e)}function handleCustom(e){trigger({eventType:"custom",traceId:getTraceId(),statement:getStatement(),content:e,url:window.location.href,navigatorInfo:getNavigatorInfo(),createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss")})}function handleClick(e){trigger({eventType:"click",traceId:getTraceId(),statement:getStatement(),content:e,url:window.location.href,navigatorInfo:getNavigatorInfo(),createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss")})}function handlePage(t,n,o,a){getAddressInfo().then(function(e){trigger({eventType:"page",traceId:getTraceId(),statement:getStatement(),stateType:t,url:o,pageStatus:a,stayTime:n,createTime:formatDate(new Date,"yyyy-MM-dd hh:mm:ss"),navigatorInfo:getNavigatorInfo(),address:e})})}function mountPageEvent(){function e(n){var o=window.history,a=o[n];return function(){var e=a.apply(o,arguments),t=new Event(n);return window.dispatchEvent(t),e}}var o=Date.now(),a="";function t(e){var t,t="load"===e?0:(t=Date.now(),n=t-o,o=t,n),n=window.location.href;a&&handlePage(e,t,a,"leave"),handlePage(e,0,a=n,"enter")}window.history.pushState=e("pushState"),window.history.replaceState=e("replaceState"),window.addEventListener("load",function(e){t("load")}),window.addEventListener("popstate",function(e){t("popstate")}),window.addEventListener("pushState",function(e){t("pushState")}),window.addEventListener("replaceState",function(e){t("replaceState")})}function mount(e){e&&loadConfig(e),mountPageEvent()}export{handleClick,handleCustom,listener,mount,mountPageEvent};
